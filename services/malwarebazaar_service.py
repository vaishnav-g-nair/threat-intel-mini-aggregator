"""
MalwareBazaar API Service.
Provides functionality to query malware samples and their metadata.
"""

import requests
from config import Config


class MalwareBazaarService:
    """
    Service class for interacting with MalwareBazaar API.
    Queries malware samples by SHA256 hash.
    """

    def __init__(self):
        """Initialize the service with API endpoint."""
        self.api_url = Config.MB_API_URL

    def query_hash(self, sha256: str) -> dict:
        """
        Query MalwareBazaar for information about a file hash.

        Args:
            sha256: SHA256 hash of the file to query

        Returns:
            dict: Normalized response with malware information or error
        """
        try:
            payload = {"query": "get_info", "hash": sha256}

            response = requests.post(self.api_url, data=payload, timeout=30)

            if response.status_code != 200:
                return {
                    "success": False,
                    "error": f"API returned status {response.status_code}",
                }

            data = response.json()

            # Check if query was successful
            if data.get("query_status") == "ok" and data.get("data"):
                return self._normalize_response(data["data"][0])

            elif data.get("query_status") == "hash_not_found":
                return {"success": True, "found": False, "data": {}}

            return {
                "success": False,
                "error": data.get("query_status", "Unknown error"),
            }

        except requests.exceptions.Timeout:
            return {
                "success": False,
                "error": "Request timeout - API may be unavailable",
            }
        except requests.exceptions.RequestException as e:
            return {"success": False, "error": f"Network error: {str(e)}"}
        except Exception as e:
            return {"success": False, "error": f"Unexpected error: {str(e)}"}

    def _normalize_response(self, raw_data: dict) -> dict:
        """
        Normalize MalwareBazaar response to consistent format.

        Args:
            raw_data: Raw API response data

        Returns:
            dict: Normalized malware information
        """
        file_info = raw_data.get("file", {})

        return {
            "success": True,
            "found": True,
            "data": {
                "malware_family": file_info.get("signature", {}).get("family", []),
                "tags": file_info.get("tags", []),
                "first_seen": file_info.get("first_seen", ""),
                "file_type": file_info.get("filetype", ""),
                "file_name": file_info.get("name", ""),
                "file_size": file_info.get("size", 0),
                "mime_type": file_info.get("mime_type", ""),
                "ssdeep": file_info.get("ssdeep", ""),
                "imphash": file_info.get("imphash", ""),
            },
        }
